rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Rules for the main user data documents
    match /users/{userId} {
      // READ: You can read a document if:
      // 1. It's your own document (to check for a pointerToCorpsData).
      // 2. You are listed in the permissions map of the document you're trying to read.
      allow read: if request.auth.uid == userId ||
                   (request.auth.uid != null && get(/databases/$(database)/documents/users/$(userId)).data.settings.permissions[request.auth.uid] != null);

      // CREATE: You can only create your own user document.
      allow create: if request.auth.uid == userId;
      
      // UPDATE: You can update a document if:
      // 1. It's your own document (e.g., to add a pointer when accepting an invite).
      // 2. You have 'owner' or 'editor' role on the document you're trying to update.
      allow update: if request.auth.uid == userId ||
                     (get(/databases/$(database)/documents/users/$(userId)).data.settings.permissions[request.auth.uid] in ['owner', 'editor']);
    }
    
    // Rules for invitation documents
    match /invites/{inviteId} {
      // CREATE: The corps owner can create invites for their dataset.
      allow create: if request.auth.uid == request.resource.data.corpsDataOwnerId;
      
      // READ: The owner who sent it or the person being invited (by email) can read the invite.
      allow read: if request.auth.uid == resource.data.corpsDataOwnerId ||
                   request.auth.token.email == resource.data.inviteeEmail;
                   
      // UPDATE:
      // 1. The invitee can update the status to 'accepted'.
      // 2. The owner can update the status to 'processed'.
      allow update: if (request.auth.token.email == resource.data.inviteeEmail && request.resource.data.status == 'accepted') ||
                     (request.auth.uid == resource.data.corpsDataOwnerId && request.resource.data.status == 'processed');
    }
  }
}
